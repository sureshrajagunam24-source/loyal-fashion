<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart - Loyal Fashion</title>
    <style>
        :root { --primary: #ff3f6c; --dark: #282c3f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; margin: 0; color: #333; }
        
        .header { background: #fff; padding: 15px 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .header h2 { margin: 0; color: var(--dark); }
        .back-btn { background: #fff; color: var(--primary); border: 2px solid var(--primary); padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: #fff; }

        .cart-container { padding: 30px; max-width: 800px; margin: 20px auto; }
        
        .cart-item { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 12px; display: flex; align-items: center; gap: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; }
        .cart-item img { width: 90px; height: 110px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
        
        .details { flex: 1; }
        .details b { font-size: 18px; display: block; margin-bottom: 5px; color: var(--dark); }
        .details .size-badge { display: inline-block; background: #ffeef2; color: var(--primary); font-size: 12px; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-bottom: 5px; }
        .details .price { color: #000; font-weight: bold; font-size: 18px; margin-top: 5px; }
        
        .remove { background: #ffebee; color: #c62828; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .remove:hover { background: #ffcdd2; }
        
        .checkout-section { padding: 25px 30px; background: #fff; border-top: 1px solid #ddd; position: sticky; bottom: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; border-radius: 12px 12px 0 0; }
        .checkout-section h3 { margin: 0; font-size: 20px; color: var(--dark); }
        .checkout { background: var(--dark); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .checkout:hover { background: #000; }
        
        .empty-cart { text-align: center; padding: 60px 20px; background: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .empty-cart h3 { color: var(--dark); margin-bottom: 10px; }
        .empty-cart p { color: #888; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="header">
    <h2>üõí Your Cart</h2>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Continue Shopping</button>
</div>

<div class="cart-container" id="cartList"></div>

<div class="checkout-section" id="checkout-panel">
    <h3>Total: <span style="color:var(--primary);">‚Çπ<span id="total">0</span></span></h3>
    <button class="checkout" id="checkout-btn" onclick="checkout()">Place All Orders</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig={
    apiKey:"AIzaSyCax6078YpxQU0kHIChQLuEmpLUYXSxQr4",
    authDomain:"e-commerce-wepsite.firebaseapp.com",
    projectId:"e-commerce-wepsite",
    storageBucket:"e-commerce-wepsite.appspot.com",
    messagingSenderId:"394408704286",
    appId:"1:394408704286:web:9ad690a946b225ab20f10f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

let cart = JSON.parse(localStorage.getItem("cart")) || [];
const list = document.getElementById("cartList");
const totalEl = document.getElementById("total");
const checkoutPanel = document.getElementById("checkout-panel");

/* RENDER CART & TOTAL CALCULATION */
function renderCart(){
    list.innerHTML="";
    let total=0;

    if(cart.length === 0) {
        list.innerHTML = `
        <div class="empty-cart">
            <h3>Your cart is empty! üõçÔ∏è</h3>
            <p>Looks like you haven't added anything to your cart yet.</p>
            <button class="checkout" onclick="window.location.href='index.html'">Shop Now</button>
        </div>`;
        checkoutPanel.style.display = "none";
        return;
    }

    checkoutPanel.style.display = "flex";

    cart.forEach((item,index)=>{
        total += Number(item.price);
        const itemSize = item.size || 'Free Size';

        list.innerHTML+=`
        <div class="cart-item">
            <img src="${item.image || item.imageUrl}" alt="product">
            <div class="details">
                <b>${item.name || item.productName}</b>
                <span class="size-badge">Size: ${itemSize}</span><br>
                <div class="price">‚Çπ${item.price}</div>
            </div>
            <button class="remove" onclick="removeItem(${index})">üóë Remove</button>
        </div>`;
    });

    totalEl.innerText=total;
}

function removeItem(index){
    cart.splice(index,1);
    localStorage.setItem("cart",JSON.stringify(cart));
    renderCart();
}

/* CHECKOUT WITH DATABASE SYNC */
async function checkout(){
    const user = auth.currentUser;
    if(!user) {
        alert("Please login to place your order! üë§");
        window.location.href = 'index.html';
        return;
    }

    if(cart.length === 0){
        alert("Cart is empty! ‚ùå");
        return;
    }

    const btn = document.getElementById("checkout-btn");
    btn.innerText = "Processing... ‚è≥";
    btn.disabled = true;

    try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if(!userDoc.exists || !userDoc.data().address) {
            alert("‚ö†Ô∏è Please update your Delivery Address in your Profile first!");
            window.location.href = 'index.html';
            return;
        }

        const userData = userDoc.data();

        // Placing orders for each item in cart
        for(let item of cart) {
            await db.collection("orders").add({
                user: user.email,
                buyerName: userData.name || user.email.split('@')[0],
                buyerMobile: userData.mobile || '',
                buyerAddress: userData.address || '',
                productName: item.name || item.productName,
                price: item.price,
                imageUrl: item.image || item.imageUrl,
                size: item.size || 'Free Size', // Size track panra logic sethachu
                status: 'Pending',              // Default status Admin panel ku
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        alert("Orders Placed Successfully! ‚úÖ");
        localStorage.removeItem("cart");
        cart=[];
        window.location.href = 'my-orders.html';

    } catch (err) {
        alert("Error during checkout: " + err.message);
        btn.innerText = "Place All Orders";
        btn.disabled = false;
    }
}

// Auth state check panrom, then render panrom
auth.onAuthStateChanged(user => {
    renderCart();
});
</script>

</body>
</html>
