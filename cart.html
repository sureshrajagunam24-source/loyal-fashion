<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Cart - Loyal Fashion</title>

<style>
body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f9; margin:0; color: #333;}
.header{background:#000; color:#fff; padding:15px 30px; display:flex; justify-content:space-between; align-items: center;}
.cart-container{padding:30px; max-width: 800px; margin: 0 auto;}
.cart-item{
    background:#fff;
    padding:15px;
    margin-bottom:15px;
    border-radius:8px;
    display:flex;
    align-items:center;
    gap:20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.cart-item img{
    width:80px;
    height:80px;
    object-fit:cover;
    border-radius:6px;
}
.details{flex:1}
.details b { font-size: 16px; display: block; margin-bottom: 5px; }
button{padding:8px 15px; border:none; border-radius:5px; cursor:pointer; font-weight: bold;}
.remove{background:#ff4d4d; color:white; transition: 0.3s;}
.remove:hover{background: #d32f2f;}
.checkout-section { padding: 20px 30px; background: #fff; border-top: 1px solid #ddd; position: sticky; bottom: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
.checkout{background:#28a745; color:white; padding:12px 25px; font-size: 16px;}
.checkout:hover{background: #218838;}
</style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">üõí Your Shopping Cart</h2>
    <button onclick="window.location.href='index.html'" style="background:#fff; color:#000;">Back to Shop</button>
</div>

<div class="cart-container" id="cartList"></div>

<div class="checkout-section">
    <h3 style="margin:0;">Total Amount: <span style="color:#ff3f6c;">‚Çπ<span id="total">0</span></span></h3>
    <button class="checkout" onclick="checkout()">Place All Orders</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig={
    apiKey:"AIzaSyCax6078YpxQU0kHIChQLuEmpLUYXSxQr4",
    authDomain:"e-commerce-wepsite.firebaseapp.com",
    projectId:"e-commerce-wepsite",
    storageBucket:"e-commerce-wepsite.appspot.com",
    messagingSenderId:"394408704286",
    appId:"1:394408704286:web:9ad690a946b225ab20f10f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

let cart = JSON.parse(localStorage.getItem("cart")) || [];
const list = document.getElementById("cartList");
const totalEl = document.getElementById("total");

/* RENDER CART & TOTAL CALCULATION */
function renderCart(){
    list.innerHTML="";
    let total=0;

    if(cart.length === 0) {
        list.innerHTML = "<div style='text-align:center; padding:50px;'><h3>Your cart is empty! üõç</h3></div>";
        totalEl.innerText = 0;
        return;
    }

    cart.forEach((item,index)=>{
        // Total price calculation logic
        total += Number(item.price);

        list.innerHTML+=`
        <div class="cart-item">
            <img src="${item.image}" alt="product">
            <div class="details">
                <b>${item.name}</b>
                <span style="color: #666; font-weight: bold;">‚Çπ${item.price}</span>
            </div>
            <button class="remove" onclick="removeItem(${index})">Remove</button>
        </div>`;
    });

    totalEl.innerText=total;
}

function removeItem(index){
    cart.splice(index,1);
    localStorage.setItem("cart",JSON.stringify(cart));
    renderCart();
}

/* CHECKOUT WITH DATABASE SYNC */
async function checkout(){
    const user = auth.currentUser;
    if(!user) {
        alert("Please login to checkout! üë§");
        window.location.href = 'index.html';
        return;
    }

    if(cart.length === 0){
        alert("Cart is empty! ‚ùå");
        return;
    }

    // Buyer address fetch panra logic
    try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if(!userDoc.exists || !userDoc.data().address) {
            alert("‚ö† Update your Delivery Address in Profile first!");
            window.location.href = 'index.html';
            return;
        }

        const userData = userDoc.data();

        // Placing orders for each item in cart
        for(let item of cart) {
            await db.collection("orders").add({
                user: user.email,
                buyerName: userData.name,
                buyerMobile: userData.mobile,
                buyerAddress: userData.address,
                productName: item.name,
                price: item.price,
                imageUrl: item.image,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        alert("Orders Placed Successfully! ‚úÖ Payment Simulated.");
        localStorage.removeItem("cart");
        cart=[];
        renderCart();
        window.location.href = 'my-orders.html';

    } catch (err) {
        alert("Error during checkout: " + err.message);
    }
}

renderCart();
</script>

</body>
</html>
