<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Loyal Fashion</title>
<style>
body{margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;display:flex;height:100vh;background:#f4f6f9;}
.sidebar{width:250px;background:#000;color:#fff;display:flex;flex-direction:column;padding:20px;}
.logo{text-align:center;margin-bottom:40px;}
.logo img{width:60px;border-radius:50%;}
.logo h2{margin:10px 0 0 0; font-size: 18px; letter-spacing: 1px;}
.nav-item{padding:15px;margin-bottom:10px;border-radius:8px;cursor:pointer; transition: 0.3s; font-weight: 500;}
.nav-item:hover, .nav-item.active{background:#222;color:#ffd700;}
.logout{margin-top:auto;background:#ff4d4d;text-align:center; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;}
.main{flex:1;padding:40px;overflow:auto;}
.card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.05);margin-bottom:25px;}

/* Form & Table Styles */
input, select{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ddd; box-sizing: border-box;}
button{padding:10px 15px;border:none;border-radius:6px;cursor:pointer; font-weight: bold;}
.post-btn{width:100%;background:#007bff;color:#fff; padding: 12px; margin-top: 10px;}
.edit-btn{background:#ffc107; margin-right: 5px;}
.delete-btn{background:#dc3545;color:#fff;}

table{width:100%;border-collapse:collapse;}
th,td{padding:15px;border-bottom:1px solid #eee;text-align:left;}
.order-img{width:60px; height: 60px; object-fit: cover; border-radius:8px; border: 1px solid #ddd;}
.tab{display:none;}
.tab.active-tab{display:block;}

/* Buyer Details Styles */
.buyer-info-box { font-size: 13px; line-height: 1.5; }
.buyer-name { font-weight: bold; color: #ff3f6c; font-size: 15px; display: block; margin-bottom: 3px; }
.status-select { padding: 8px; border-radius: 4px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
</style>
</head>

<body>

<div class="sidebar">
    <div class="logo">
        <img src="image.png" alt="Logo">
        <h2>LOYAL FASHION</h2>
    </div>
    <div class="nav-item active" id="nav-dashboard" onclick="showTab('dashboard')">üìä Dashboard</div>
    <div class="nav-item" id="nav-addProduct" onclick="showTab('addProduct')">‚ûï Add Product</div>
    <div class="nav-item" id="nav-inventory" onclick="showTab('inventory')">üì¶ Inventory</div>
    <div class="nav-item" id="nav-orders" onclick="showTab('orders')">üßæ Orders</div>
    <div class="logout" onclick="logout()">üö™ Logout</div>
</div>

<div class="main">
    <div id="dashboard" class="tab active-tab">
        <div class="card">
            <h2>Dashboard Overview</h2>
            <p style="font-size: 18px;">Total Products: <span id="total" style="color: #007bff; font-weight: bold;">0</span></p>
        </div>
    </div>

    <div id="addProduct" class="tab">
        <div class="card">
    <h2 id="form-title">Add New Product (6 Gallery Images)</h2>
    <input type="text" id="pName" placeholder="Product Name">
    <input type="number" id="pPrice" placeholder="Price (‚Çπ)">
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>1. Main Image (Front):</label>
            <input type="file" id="pImage1" accept="image/*">
            <label>2. Side View:</label>
            <input type="file" id="pImage2" accept="image/*">
            <label>3. Back View:</label>
            <input type="file" id="pImage3" accept="image/*">
        </div>
        <div>
            <label>4. Detail View 1:</label>
            <input type="file" id="pImage4" accept="image/*">
            <label>5. Detail View 2:</label>
            <input type="file" id="pImage5" accept="image/*">
            <label>6. Label/Tag View:</label>
            <input type="file" id="pImage6" accept="image/*">
        </div>
    </div>
    
    <button class="post-btn" id="save-btn" onclick="saveProduct()">Save Product with 6 Images</button>
</div>

    <div id="inventory" class="tab">
        <div class="card">
            <h2>Inventory Control</h2>
            <table>
                <thead>
                    <tr><th>Image</th><th>Name</th><th>Price</th><th>Action</th></tr>
                </thead>
                <tbody id="product-table"></tbody>
            </table>
        </div>
    </div>

    <div id="orders" class="tab">
        <div class="card">
            <h2>Buyer Live Orders</h2>
            <table>
                <thead>
                    <tr><th>Image</th><th>Product</th><th>Price</th><th>Buyer & Delivery Info</th><th>Status</th></tr>
                </thead>
                <tbody id="orders-table"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { 
    getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCax6078YpxQU0kHIChQLuEmpLUYXSxQr4",
  authDomain: "e-commerce-wepsite.firebaseapp.com",
  projectId: "e-commerce-wepsite",
  storageBucket: "e-commerce-wepsite.appspot.com",
  messagingSenderId: "394408704286",
  appId: "1:394408704286:web:9ad690a946b225ab20f10f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let editId = null;

onAuthStateChanged(auth, (user)=>{
    const isAdmin = localStorage.getItem("isAdminLoggedIn");
    if(!user || user.email !== "sureshrajagunam24@gmail.com" || isAdmin !== "true"){
        window.location.href="admin-login.html";
    } else {
        loadProducts();
        loadOrders();
    }
});

window.showTab = function(tabId){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('nav-' + tabId).classList.add('active');
}

window.logout = function(){
    if(confirm("Logout from Admin Panel?")){
        signOut(auth).then(() => {
            localStorage.removeItem("isAdminLoggedIn");
            window.location.href="admin-login.html";
        });
    }
}

window.saveProduct = async function(){
    const name = document.getElementById("pName").value.trim();
    const price = document.getElementById("pPrice").value.trim();
    const file = document.getElementById("pImage").files[0];
    const status = document.getElementById("status-msg");

    if(!name || !price){ status.innerText="Fill all fields! ‚ùå"; return; }
    status.innerText = "Processing... ‚è≥";

    if(file){
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const imgData = reader.result;
            if(editId){
                await updateDoc(doc(db, "products", editId), { productName: name, price: Number(price), imageUrl: imgData });
                editId = null;
            } else {
                await addDoc(collection(db, "products"), { productName: name, price: Number(price), imageUrl: imgData, createdAt: serverTimestamp() });
            }
            clearForm(); status.innerText="Success ‚úÖ";
        }
    } else if(editId) {
        await updateDoc(doc(db, "products", editId), { productName: name, price: Number(price) });
        editId = null; clearForm(); status.innerText="Updated ‚úÖ";
    }
}

function loadProducts(){
    onSnapshot(collection(db, "products"), (snapshot) => {
        const table = document.getElementById("product-table");
        table.innerHTML = "";
        document.getElementById("total").innerText = snapshot.size;
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            table.innerHTML += `<tr><td><img src="${data.imageUrl}" class="order-img"></td><td>${data.productName}</td><td>‚Çπ${data.price}</td><td><button class="edit-btn" onclick="editProduct('${docSnap.id}','${data.productName}','${data.price}')">Edit</button><button class="delete-btn" onclick="deleteProduct('${docSnap.id}')">Delete</button></td></tr>`;
        });
    });
}

/* UPDATE STATUS LOGIC */
window.updateOrderStatus = async function(orderId, newStatus) {
    try {
        await updateDoc(doc(db, "orders", orderId), { status: newStatus });
        console.log("Status Updated to: " + newStatus);
    } catch (err) { alert("Firebase Rule Error: Update permission missing!"); }
}

function loadOrders(){
    const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const table = document.getElementById("orders-table");
        table.innerHTML = "";
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const orderId = docSnap.id;
            const statusColor = data.status === 'Delivered' ? '#28a745' : (data.status === 'Shipped' ? '#007bff' : '#ef6c00');
            
            table.innerHTML += `
            <tr>
                <td><img src="${data.imageUrl || 'image.png'}" class="order-img"></td>
                <td><b>${data.productName}</b></td>
                <td>‚Çπ${data.price}</td>
                <td class="buyer-info-box">
                    <span class="buyer-name">${data.buyerName || 'Unknown'}</span>
                    üìû ${data.buyerMobile || 'N/A'}<br>üìç ${data.buyerAddress || 'N/A'}<br>üìß <small>${data.user}</small>
                </td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${orderId}', this.value)" style="color:${statusColor}; border-color:${statusColor};">
                        <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Shipped" ${data.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                        <option value="Delivered" ${data.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                    </select>
                </td>
            </tr>`;
        });
    });
}

window.editProduct = function(id, name, price){ showTab('addProduct'); document.getElementById("pName").value = name; document.getElementById("pPrice").value = price; editId = id; }
window.deleteProduct = async function(id){ if(confirm("Delete product?")) await deleteDoc(doc(db, "products", id)); }
window.clearForm = function(){ document.getElementById("pName").value=""; document.getElementById("pPrice").value=""; document.getElementById("pImage").value=""; }
</script>
</body>
</html>
